suite: secret
templates:
  - secret.yaml

tests:
  # ── inline token → chart-managed Secret ──────────────────────────────────────
  - it: renders a Secret when apiToken is set
    set:
      apiToken: "my-betterstack-token"
    asserts:
      - isKind:
          of: Secret
      - hasDocuments:
          count: 1
      - equal:
          path: type
          value: Opaque
      - equal:
          path: stringData["api-token"]
          value: "my-betterstack-token"

  - it: Secret name matches fullname helper
    set:
      apiToken: "tok"
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-betterstack-monitor-controller

  - it: Secret is created in the release namespace
    set:
      apiToken: "tok"
    asserts:
      - equal:
          path: metadata.namespace
          value: NAMESPACE

  # ── existing secret → no chart-managed Secret ─────────────────────────────────
  - it: does not render a Secret when existingSecret.name is set
    set:
      existingSecret.name: my-external-secret
    asserts:
      - hasDocuments:
          count: 0

  - it: does not render a Secret when neither apiToken nor existingSecret are set
    asserts:
      - hasDocuments:
          count: 0

  # ── standard labels ──────────────────────────────────────────────────────────
  - it: includes standard Helm labels on the Secret
    set:
      apiToken: "tok"
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm
