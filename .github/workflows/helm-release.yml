name: Helm Release

# Publishes the Helm chart to the repo's GitHub Pages Helm repository
# (https://luong-komorebi.github.io/betterstack-monitor-controller) whenever
# Chart.yaml version is bumped on main.
#
# No manual setup required — the workflow bootstraps the gh-pages branch and
# enables GitHub Pages automatically on first run.

on:
  push:
    branches: ["main"]
    paths:
      - "helm/**"

jobs:
  release:
    name: Chart release
    runs-on: ubuntu-latest
    permissions:
      contents: write   # push to gh-pages + create GitHub Releases
      pages: write      # enable GitHub Pages via the API

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # chart-releaser needs full history to diff tags

      - name: Configure Git
        run: |
          git config user.name  "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      # Create an empty gh-pages branch on first run so chart-releaser can
      # push the Helm index there without failing.
      - name: Bootstrap gh-pages branch
        run: |
          if git ls-remote --exit-code origin gh-pages; then
            echo "gh-pages branch already exists, skipping bootstrap."
          else
            echo "Creating orphan gh-pages branch..."
            git checkout --orphan gh-pages
            git rm -rf .
            git commit --allow-empty -m "chore: init gh-pages for Helm chart repo"
            git push origin gh-pages
            git checkout main
          fi

      # Enable GitHub Pages on the gh-pages branch if not already enabled.
      # The API call is idempotent — it's a no-op if Pages is already on.
      - name: Enable GitHub Pages
        continue-on-error: true   # non-fatal if Pages is already enabled or permissions differ
        run: |
          curl -sS -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/pages" \
            -d '{"source":{"branch":"gh-pages","path":"/"}}'

      - name: Set up Helm
        uses: azure/setup-helm@v4

      # chart-releaser packages each chart whose version hasn't been released
      # yet, creates a GitHub Release for it, then updates index.yaml on
      # gh-pages so `helm repo update` picks up the new chart immediately.
      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          charts_dir: helm
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
